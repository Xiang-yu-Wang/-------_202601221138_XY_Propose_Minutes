# Nginx 配置範例 - 生產環境壓縮與快取策略
# 複製到 /etc/nginx/sites-available/ 並建立軟連結到 sites-enabled/

server {
    listen 80;
    listen [::]:80;
    
    # 替換為你的實際域名
    server_name dakura-gifts.com.tw www.dakura-gifts.com.tw;
    
    # 網站根目錄 - 指向 dist 資料夾
    root /var/www/shareholder-gift/dist;
    index index.html;

    # ========================================
    # Gzip 壓縮配置（生產環境必備）
    # ========================================
    
    # 啟用 Gzip 壓縮
    gzip on;
    
    # 啟用 Vary: Accept-Encoding 標頭（CDN 快取關鍵）
    gzip_vary on;
    
    # 代理請求也啟用壓縮
    gzip_proxied any;
    
    # 壓縮等級（1-9，建議 6）
    # 1 = 最快但壓縮率低，9 = 最慢但壓縮率高
    gzip_comp_level 6;
    
    # 緩衝區大小
    gzip_buffers 16 8k;
    
    # 最小壓縮檔案大小（小於此值不壓縮，避免開銷）
    gzip_min_length 1024;
    
    # 壓縮的 HTTP 版本
    gzip_http_version 1.1;
    
    # 需要壓縮的 MIME 類型
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/xml+rss
        application/rss+xml
        application/atom+xml
        application/ld+json
        image/svg+xml
        font/woff
        font/woff2
        font/ttf
        font/eot
        font/otf;
    
    # 對已壓縮的檔案類型不再壓縮（如 jpg, png, zip）
    gzip_disable "msie6";

    # ========================================
    # Brotli 壓縮配置（需安裝 ngx_brotli 模組）
    # ========================================
    
    # 啟用 Brotli（比 Gzip 壓縮率高 15-20%）
    # 需先安裝: sudo apt install libbrotli-dev
    # brotli on;
    # brotli_comp_level 6;
    # brotli_static on;
    # brotli_types
    #     text/plain
    #     text/css
    #     text/javascript
    #     application/javascript
    #     application/json
    #     application/xml
    #     image/svg+xml;

    # ========================================
    # 靜態資源快取策略
    # ========================================
    
    # HTML 檔案 - 不快取（確保 SPA 路由更新）
    location ~* \.html$ {
        expires -1;
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate";
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-XSS-Protection "1; mode=block" always;
        try_files $uri $uri/ /index.html;
    }
    
    # JavaScript/CSS 資源 - 長快取（含 hash）
    location ~* ^/assets/.*\.(js|css)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # 圖片資源 - 長快取
    location ~* \.(jpg|jpeg|png|gif|webp|avif|svg|ico)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # 字型檔案 - 長快取
    location ~* \.(woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # robots.txt 和 sitemap.xml - 短快取
    location ~* \.(txt|xml)$ {
        expires 1h;
        add_header Cache-Control "public";
    }

    # ========================================
    # SPA 路由處理
    # ========================================
    
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ========================================
    # 安全標頭
    # ========================================
    
    # 防止 MIME 類型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    
    # 防止點擊劫持
    add_header X-Frame-Options "DENY" always;
    
    # XSS 保護
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Content Security Policy（根據需求調整）
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https:;" always;

    # ========================================
    # 錯誤頁面
    # ========================================
    
    error_page 404 /index.html;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}

# ========================================
# HTTPS 配置（使用 Let's Encrypt）
# ========================================
# 
# 安裝 Certbot：
# sudo apt install certbot python3-certbot-nginx
# 
# 獲取憑證：
# sudo certbot --nginx -d dakura-gifts.com.tw -d www.dakura-gifts.com.tw
# 
# 自動續期：
# sudo certbot renew --dry-run
