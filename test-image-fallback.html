<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åœ–ç‰‡æ ¼å¼é™ç´šæ¸¬è©¦</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-result {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 10px 0;
      border: 2px solid #ddd;
      border-radius: 4px;
    }
    h2 { color: #059669; }
    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>ğŸ“¸ éŸ¿æ‡‰å¼åœ–ç‰‡æ ¼å¼é™ç´šæ¸¬è©¦</h1>
  <p>é€™å€‹é é¢æ¸¬è©¦ Picture å…ƒç´ çš„æ ¼å¼é™ç´šé‚è¼¯ï¼ˆAVIF â†’ WebP â†’ JPEGï¼‰</p>

  <!-- Test 1: Hero Image with Picture -->
  <div class="test-section">
    <h2>æ¸¬è©¦ 1: Hero èƒŒæ™¯åœ–ï¼ˆAVIF â†’ WebP â†’ JPEGï¼‰</h2>
    <div class="test-result info" id="hero-result">æª¢æ¸¬ä¸­...</div>
    
    <picture>
      <!-- AVIF -->
      <source 
        srcset="https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=640&q=80&fm=avif 640w,
                https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=1280&q=80&fm=avif 1280w"
        type="image/avif"
        id="hero-avif"
      />
      <!-- WebP -->
      <source 
        srcset="https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=640&q=80&fm=webp 640w,
                https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=1280&q=80&fm=webp 1280w"
        type="image/webp"
        id="hero-webp"
      />
      <!-- JPEG Fallback -->
      <img 
        srcset="https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=640&q=80 640w,
                https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=1280&q=80 1280w"
        src="https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=1280&q=80"
        alt="Hero Background"
        sizes="(max-width: 768px) 100vw, 1200px"
        id="hero-img"
        onload="reportFormat('hero', this.currentSrc)"
        onerror="reportError('hero', this.currentSrc)"
      />
    </picture>
  </div>

  <!-- Test 2: Gallery Image -->
  <div class="test-section">
    <h2>æ¸¬è©¦ 2: Gallery åœ–ç‰‡ï¼ˆWebP â†’ JPEGï¼‰</h2>
    <div class="test-result info" id="gallery-result">æª¢æ¸¬ä¸­...</div>
    
    <picture>
      <source 
        srcset="https://custom-images.strikinglycdn.com/res/hrscywv4p/image/upload/c_limit,fl_lossy,h_9000,w_1200,f_webp,q_auto/8989695/442962_244577.png 1200w"
        type="image/webp"
      />
      <img 
        src="https://custom-images.strikinglycdn.com/res/hrscywv4p/image/upload/c_limit,fl_lossy,h_9000,w_1200,f_auto,q_auto/8989695/442962_244577.png"
        alt="Gallery Item"
        id="gallery-img"
        onload="reportFormat('gallery', this.currentSrc)"
        onerror="reportError('gallery', this.currentSrc)"
      />
    </picture>
  </div>

  <!-- Test 3: Browser Support Detection -->
  <div class="test-section">
    <h2>æ¸¬è©¦ 3: ç€è¦½å™¨æ ¼å¼æ”¯æ´æª¢æ¸¬</h2>
    <div class="test-result info" id="browser-support">æª¢æ¸¬ä¸­...</div>
  </div>

  <!-- Test 4: CDN Response Test -->
  <div class="test-section">
    <h2>æ¸¬è©¦ 4: CDN éŸ¿æ‡‰æ¸¬è©¦</h2>
    <div class="test-result info" id="cdn-test">æª¢æ¸¬ä¸­...</div>
  </div>

  <script>
    // å ±å‘Šåœ–ç‰‡æ ¼å¼
    function reportFormat(testName, url) {
      const resultDiv = document.getElementById(`${testName}-result`);
      let format = 'JPEG';
      
      if (url.includes('fm=avif') || url.includes('f_avif')) {
        format = 'AVIF';
      } else if (url.includes('fm=webp') || url.includes('f_webp') || url.includes('.webp')) {
        format = 'WebP';
      }
      
      resultDiv.className = 'test-result success';
      resultDiv.innerHTML = `
        âœ… æˆåŠŸè¼‰å…¥ <code>${format}</code> æ ¼å¼<br>
        <small>URL: ${url.substring(0, 80)}...</small>
      `;
    }

    // å ±å‘ŠéŒ¯èª¤
    function reportError(testName, url) {
      const resultDiv = document.getElementById(`${testName}-result`);
      resultDiv.className = 'test-result error';
      resultDiv.innerHTML = `
        âŒ è¼‰å…¥å¤±æ•—<br>
        <small>URL: ${url.substring(0, 80)}...</small>
      `;
    }

    // æª¢æ¸¬ç€è¦½å™¨æ ¼å¼æ”¯æ´
    async function detectBrowserSupport() {
      const resultDiv = document.getElementById('browser-support');
      const formats = {
        'AVIF': 'data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAAB0AAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAIAAAACAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQ0MAAAAABNjb2xybmNseAACAAIAAYAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAACVtZGF0EgAKCBgANogQEAwgMg8f8D///8WfhwB8+ErK42A=',
        'WebP': 'data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=',
      };

      const support = {};
      
      for (const [format, dataUrl] of Object.entries(formats)) {
        try {
          const img = new Image();
          const promise = new Promise((resolve) => {
            img.onload = () => resolve(true);
            img.onerror = () => resolve(false);
          });
          img.src = dataUrl;
          support[format] = await promise;
        } catch {
          support[format] = false;
        }
      }

      const browserInfo = {
        userAgent: navigator.userAgent,
        avif: support.AVIF,
        webp: support.WebP,
      };

      let html = `
        <strong>ç€è¦½å™¨: </strong>${getBrowserName()}<br>
        <strong>AVIF æ”¯æ´: </strong>${support.AVIF ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
        <strong>WebP æ”¯æ´: </strong>${support.WebP ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
        <strong>é™ç´šé‚è¼¯: </strong>
      `;

      if (support.AVIF) {
        html += '<code>AVIF</code> (æœ€å„ª)';
      } else if (support.WebP) {
        html += '<code>WebP</code> (å‚™é¸)';
      } else {
        html += '<code>JPEG</code> (é™ç´š)';
      }

      resultDiv.className = 'test-result success';
      resultDiv.innerHTML = html;
    }

    // ç²å–ç€è¦½å™¨åç¨±
    function getBrowserName() {
      const ua = navigator.userAgent;
      if (ua.includes('Chrome')) return 'Chrome';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
      if (ua.includes('Edge')) return 'Edge';
      return 'Unknown';
    }

    // æ¸¬è©¦ CDN éŸ¿æ‡‰
    async function testCDN() {
      const resultDiv = document.getElementById('cdn-test');
      const testUrls = [
        'https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=640&q=80&fm=avif',
        'https://images.unsplash.com/photo-1553729459-efe14ef6055d?auto=format&fit=crop&w=640&q=80&fm=webp',
        'https://custom-images.strikinglycdn.com/res/hrscywv4p/image/upload/c_limit,fl_lossy,h_300,w_300,f_webp,q_auto/8989695/442962_244577.png',
      ];

      let html = '';
      for (const url of testUrls) {
        try {
          const start = performance.now();
          const response = await fetch(url, { method: 'HEAD' });
          const duration = Math.round(performance.now() - start);
          
          const formatMatch = url.match(/fm=(\w+)|f_(\w+)|\.(\w+)/);
          const format = formatMatch ? (formatMatch[1] || formatMatch[2] || formatMatch[3]).toUpperCase() : 'UNKNOWN';
          
          if (response.ok) {
            html += `âœ… ${format}: ${duration}ms (${response.headers.get('content-type')})<br>`;
          } else {
            html += `âŒ ${format}: HTTP ${response.status}<br>`;
          }
        } catch (error) {
          html += `âŒ è«‹æ±‚å¤±æ•—: ${error.message}<br>`;
        }
      }

      resultDiv.className = 'test-result success';
      resultDiv.innerHTML = html;
    }

    // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
    window.addEventListener('load', async () => {
      await detectBrowserSupport();
      await testCDN();
    });
  </script>
</body>
</html>
